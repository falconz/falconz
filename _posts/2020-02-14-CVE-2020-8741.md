---
layout: post
title: Wordpress Code Snippets CSRF CVE-2020–8417
---

- Phân loại: Cross-site Request Fogery (CSRF)
- Vị trí: plugin Code Snippets
- Lượng người dùng: ~ 200,000 website sử dụng code snippets
- Phiên bản bị lỗi: < 2.14.0

# Mô tả
1. Plugin cho phép người dùng thêm một đoạn mã PHP để mở rộng thêm tính năng của website
2. Code snippets có một menu cho phép người dùng nhập đoạn mã vào, tuy nhiên do không kiểm tra HTTP referer nên đã bị lỗ hổng CSRF
3. Hacker sẽ lừa administration truy cập vào 1 link để thực hiện câu lệnh trên chính website của mình

# Proof-of-Concept

Here, I am going to do a local setup of WordPress to show a Proof-Of-Concept exploitation. I will use Code Snippets v2.13.3 to show the vulnerability since the bug has been patched in v2.14.0.
We download, import, install, and then activate the plugin.
Tôi sẽ setup wordpress trên máy local để demo quá trình khai thác, tôi sử dụng Code Snippets v2.13.3 (bản 2.14.0) đã khắc phục lỗ hổng
![_config.yml]({{ site.baseurl }}/images/Code-Snippets.png)
Đã kích hoạt plugin Code Snippets

Tôi xoá toàn bộ code mặc định trong snippets
![_config.yml]({{ site.baseurl }}/images/Snippets.png)

Hiện tại hệ thống chỉ có một user là admin
![_config.yml]({{ site.baseurl }}/images/Snippets.png)

Tôi sẽ thực hiện exploit, và trong plugin Code snippets sẽ có một đoạn mã là "Attacker PoC" và thực hiện tạo một tài khoản là attacker trong hệ thống

# Kịch bản tấn công

Tôi tạo một comment để lừa admin click vào đường dẫn
![_config.yml]({{ site.baseurl }}/images/comments.png)

Sau khi admin truy cập vào đường dẫn thì lập tức mã độc được thực thi
![_config.yml]({{ site.baseurl }}/images/Exploit-PoC-animation.gif)

Chúng ta có thể thấy trong phần user đã được tạo một username là attacker, hacker có thể dùng tài khoản này để đăng nhập vào hệ thống và thực hiện các hành động khác nguy hiểm hơn như up shell

# Cách khắc phục

Update lên phiên bản mới nhất của Code Snippets (Tại thời điểm của bài viết này là phiên bản v2.14.0)


falconz, from VSEC with love

Tham khảo: wpsec